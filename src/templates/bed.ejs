; bed.g
; called to perform automatic <%- (template.geometry.type == 'delta') ? 'delta calibration' : 'bed compensation' %> via G32
;
; generated by RepRapFirmware Configuration Tool v<%- version %> on <%- (new Date()).toString() %>
M561 ; clear any bed transform
<%	if (template.home_first) { -%>
G28 ; home all <%- (template.geometry.type == 'delta') ? 'towers' : 'axes' %>
<%	}
	if (template.probe.deploy && template.firmware < 1.21) { -%>
M98 P"deployprobe.g" ; deploy mechanical Z probe
<%	}
	if (template.probe.points.length > 0) {
		if (template.geometry.type == 'delta') { -%>
; Probe the bed at <%- template.peripheral_points %> peripheral and <%- template.halfway_points %> halfway points, and perform <%- template.calibration_factors %>-factor auto compensation
; Before running this, you should have set up your Z-probe trigger height to suit your build, in the G31 command in config.g.
<%		} else { -%>
; Probe the bed at <%- template.probe.points.length %> points
<%		} -%>
<%		template.probe.points.forEach(function(point, index) { -%>
G30 P<%- index %> X<%- point.x %> Y<%- point.y %> H<%- point.z %> Z-99999<%- (index + 1 == template.probe.points.length) ? ' S'  + (template.geometry.type == 'delta' ? template.calibration_factors : '') : '' %>
<%		});
		if (template.geometry.type == 'delta') { -%>
; Use S-1 for measurements only, without calculations. Use S4 for endstop heights and Z-height only. Use S6 for full 6 factors
; If your Z probe has significantly different trigger heights depending on XY position, adjust the H parameters in the G30 commands accordingly. The value of each H parameter should be (trigger height at that XY position) - (trigger height at centre of bed)
<%		}
	} else { -%>
G29 ; probe the bed and enable compensation
<%	}
	if (template.probe.deploy && template.firmware < 1.21) { -%>
M98 P"retractprobe.g" ; retract mechanical Z probe
<%	} -%>

